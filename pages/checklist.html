<!DOCTYPE html>
<html>
<head>
  <title>Travel Checklist</title>
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    /* Center everything vertically and horizontally */
    body {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
    }

    .container {
        width: 100%;
        max-width: 800px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    #controls {
        width: 100%;
        max-width: 500px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
    }

    #newItem {
        width: 100%;
        padding: 12px;
        box-sizing: border-box;
    }

    #controls button {
        width: 100%;
    }

    /* Checklist list styling */
    .checklist {
        width: 100%;
        max-width: 600px;
        padding: 0;
        margin: 0;
    }

    /* Back button container */
    .back-container {
        width: 100%;
        max-width: 500px;
        margin-top: 20px;
        display: flex;
        justify-content: center;
    }

    /* Existing checklist item styles */
    .checklist li {
        margin: 10px 0;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 5px;
        display: flex;
        align-items: center;
    }

    input[type="checkbox"]:checked + input[type="text"] {
        text-decoration: line-through;
        color: #888;
    }

    .checklist input[type="text"] {
        margin-left: 10px;
        flex-grow: 1;
        border: none;
        background: transparent;
        padding: 5px;
    }

    .delete-btn {
        margin-left: 10px;
        cursor: pointer;
        color: #ff4444;
    }
</style>
</head>
<body>
  <div class="container">
    <h1>Editable Travel Checklist</h1>
    
    <div id="controls">
      <input type="text" id="newItem" placeholder="Enter new item...">
      <button onclick="addItem()">Add Item</button>
      <button onclick="resetChecklist()">Reset All</button>
    </div>
    
    <ul class="checklist" id="checklist"></ul>
    
    <div class="back-container">
      <a href="map.html">
        <button style="background: #6c757d;">Back to Main Page</button>
      </a>
    </div>
  </div>

    <script>
    // Encryption configuration
    const ENCRYPTION_CONFIG = {
      name: 'AES-GCM',
      length: 256,
      iterations: 100000,
      salt: new TextEncoder().encode('static-salt-123'),
      passphrase: 'secret-passphrase'
    };

    // Generate crypto key
    async function getCryptoKey() {
      const keyMaterial = await crypto.subtle.importKey(
        'raw',
        new TextEncoder().encode(ENCRYPTION_CONFIG.passphrase),
        {name: 'PBKDF2'},
        false,
        ['deriveKey']
      );

      return crypto.subtle.deriveKey(
        {
          name: 'PBKDF2',
          salt: ENCRYPTION_CONFIG.salt,
          iterations: ENCRYPTION_CONFIG.iterations,
          hash: 'SHA-256'
        },
        keyMaterial,
        {name: ENCRYPTION_CONFIG.name, length: ENCRYPTION_CONFIG.length},
        true,
        ['encrypt', 'decrypt']
      );
    }

    // Encrypt data
    async function encrypt(data) {
      const key = await getCryptoKey();
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const encoded = new TextEncoder().encode(data);
      
      const ciphertext = await crypto.subtle.encrypt(
        {name: ENCRYPTION_CONFIG.name, iv},
        key,
        encoded
      );

      return {
        iv: Array.from(iv),
        ciphertext: Array.from(new Uint8Array(ciphertext))
      };
    }

    // Decrypt data
    async function decrypt(encrypted) {
      const key = await getCryptoKey();
      const iv = new Uint8Array(encrypted.iv);
      const ciphertext = new Uint8Array(encrypted.ciphertext);
      
      const decrypted = await crypto.subtle.decrypt(
        {name: ENCRYPTION_CONFIG.name, iv},
        key,
        ciphertext
      );

      return new TextDecoder().decode(decrypted);
    }

    // Modified save/load functions with encryption
    async function saveChecklist() {
      const items = Array.from(document.querySelectorAll('.checklist li')).map(li => ({
        text: li.querySelector('input[type="text"]').value,
        checked: li.querySelector('input[type="checkbox"]').checked
      }));
      
      const encrypted = await encrypt(JSON.stringify(items));
      localStorage.setItem('checklist', JSON.stringify(encrypted));
    }

    async function loadChecklist() {
      const encryptedData = localStorage.getItem('checklist');
      if (!encryptedData) return;

      try {
        const decrypted = await decrypt(JSON.parse(encryptedData));
        const savedItems = JSON.parse(decrypted);
        const checklist = document.getElementById('checklist');
        
        savedItems.forEach(item => {
          const li = createListItem(item.text, item.checked);
          checklist.appendChild(li);
        });
      } catch (error) {
        console.error('Decryption failed:', error);
        localStorage.removeItem('checklist');
      }
    }

    // Update event listeners to handle async operations
    document.addEventListener('DOMContentLoaded', () => {
      loadChecklist().catch(console.error);
    });

    document.getElementById('checklist').addEventListener('input', () => {
      saveChecklist().catch(console.error);
    });

    document.getElementById('checklist').addEventListener('change', () => {
      saveChecklist().catch(console.error);
    });
  </script>
</body>
</html>
