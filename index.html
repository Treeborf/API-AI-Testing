<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QnA Workaround Solution</title>
</head>
<body>
  <h1>Alternative QnA Implementation</h1>
  
  <textarea id="context" placeholder="Context..." rows="6" cols="60"></textarea><br>
  <input id="question" placeholder="Question..." size="60"><br>
  <button id="ask">Ask</button>
  <p id="answer"></p>

  <script type="module">
  // Extreme input sanitization version
  import { env, AutoTokenizer, AutoModelForQuestionAnswering } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@latest/dist/transformers.min.js';

  // Configure environment
  env.allowLocalModels = false;
  env.useBrowserCache = false;
  env.backends.onnx.wasm.numThreads = 1;

  // Atomic components initialization
  let tokenizer, model;
  
  try {
    [tokenizer, model] = await Promise.all([
      AutoTokenizer.from_pretrained('Xenova/distilbert-base-cased-distilled-squad', {
        revision: 'main',
        auth: null,  // Ensure no auth tokens
      }),
      AutoModelForQuestionAnswering.from_pretrained('Xenova/distilbert-base-cased-distilled-squad', {
        quantized: true,
      })
    ]);
    console.log('Core components loaded');
  } catch (err) {
    document.getElementById('answer').textContent = 
      `❌ Failed to load model: ${err.message}`;
    throw err;
  }

  document.getElementById('ask').addEventListener('click', async () => {
    const rawContext = document.getElementById('context').value;
    const rawQuestion = document.getElementById('question').value;
    
    // Nuclear input sanitization
    const context = String(rawContext)
      .replace(/[^\w\s.,!?;:'"-]/g, '')
      .replace(/\s+/g, ' ')
      .trim()
      .substring(0, 2000);
    
    const question = String(rawQuestion)
      .replace(/[^\w\s?]/g, '')
      .trim()
      .substring(0, 100);

    if (!context || !question) {
      document.getElementById('answer').textContent = '⚠️ Invalid inputs';
      return;
    }

    try {
      // Manual tokenization
      const inputs = await tokenizer.encode(question, context);
      console.log('Tokenization succeeded:', inputs);

      // Manual model execution
      const outputs = await model(inputs);
      const answer = tokenizer.decode(outputs.start_logits, outputs.end_logits);
      
      document.getElementById('answer').textContent = 
        `✅ Answer: ${answer}`;
    } catch (err) {
      console.error('Full error context:', {
        error: err,
        context: new TextEncoder().encode(context),
        question: new TextEncoder().encode(question),
        tokenizerStatus: !!tokenizer,
        modelStatus: !!model
      });
      
      document.getElementById('answer').textContent = 
        `❌ Error: ${err.message.split('\n')[0]}`;
    }
  });
  </script>

  <!-- Fallback message if WASM fails -->
  <noscript>
    <p style="color: red">JavaScript is required for this application.</p>
  </noscript>
</body>
</html>
